# Комплексная информационная система "Цифровой Строительный Контроль"

**Разработано командой "ShutDown Team"**

---

## 1. Executive Summary

**"Цифровой Строительный Контроль"** — это комплексная информационная платформа, предназначенная для полной цифровизации и автоматизации процессов управления в сфере благоустройства городских территорий. Система создает единую, прозрачную и контролируемую среду для всех участников строительного процесса: службы заказчика, инспекторов контрольных органов и прорабов подрядных организаций.

Платформа решает ключевые проблемы отрасли, такие как срыв сроков, нецелевое использование материалов, отсутствие достоверных данных о ходе работ и сложная коммуникация. За счет внедрения **AI-автоматизации**, **проактивного управления рисками** и **сквозного контроля на основе геолокации**, система обеспечивает беспрецедентный уровень прозрачности и эффективности.

**Ключевая ценность:** Превращение хаотичного и непрозрачного процесса строительства в управляемый, предсказуемый и полностью документированный цифровой конвейер.

---

## 2. Решаемые проблемы отрасли

Система нацелена на устранение системных недостатков в управлении городским благоустройством:

| Проблема | Последствия | Решение в системе |
| :--- | :--- | :--- |
| **Непрозрачные поставки материалов** | Ручной ввод данных из ТТН, ошибки, задержки, невозможность оперативного контроля качества и объемов. | **AI-распознавание документов:** Автоматическое извлечение данных из ТТN, валидация по плану и мгновенная фиксация в системе. |
| **Срыв сроков выполнения работ** | Позднее обнаружение отклонений от графика, "штурмовщина", штрафы и недовольство жителей. | **Проактивная система рисков:** Динамический скоринг проектов по 8 факторам, который сигнализирует о проблемах до их наступления. |
| **Отсутствие достоверных данных** | Фальсификация журналов работ, невозможность доказать или опровергнуть факт выполнения работ в срок. | **Цифровой журнал с геолокацией:** Каждое действие (завершение задачи, отчет, замечание) фиксируется с гео-меткой и таймстампом. |
| **Децентрализованное планирование** | Отсутствие единого, актуального плана работ, доступного всем участникам. Задачи существуют в отрыве от графика. | **Обязательное планирование:** Ни одна задача не может быть создана без привязки к конкретному пункту детализированного плана работ. |
| **Задержки в коммуникации** | Критичная информация (о нарушениях, срывах, завершении этапов) теряется или доходит с опозданием. | **Система уведомлений в реальном времени:** Автоматические мгновенные оповещения всем заинтересованным сторонам о ключевых событиях. |

---

## 3. Архитектура и технологический стек

Платформа построена на современном и надежном технологическом стеке, обеспечивающем масштабируемость, безопасность и удобство использования.

### 3.1. Технологический стек

### Backend
- **Framework**: Flask 
- **ORM**: SQLAlchemy
- **База данных**: PostgreSQL 13
- **Аутентификация**: JWT (Flask-JWT-Extended)
- **Хеширование паролей**: bcrypt
- **Геокодирование**: Geopy с Nominatim (OpenStreetMap)
- **AI интеграция**: Qwen API для распознавания документов
- **Асинхронные задачи и очереди**: Celery + Redis (для AI-распознавания документов и других фоновых задач)
- **CORS**: Flask-CORS
- **Генерация документов**: python-docx

### Frontend
- **Framework**: React 19.1.1
- **Сборщик**: Vite с PostCSS
- **Стилизация**: TailwindCSS
- **Роутинг**: React Router DOM
- **Картография**: Leaflet и React-Leaflet с тайлами OpenStreetMap
- **Визуализация данных**: Recharts для графиков и дашбордов
- **UI**: Lucide React (иконки), React Hot Toast (системные уведомления)

#### **DevOps и Инфраструктура**
- **Контейнеризация**: Docker и Docker Compose для быстрого развертывания
- **Веб-автоматизация**: Playwright для фонового обновления сессий AI-сервиса
- **Файловое хранилище**: Локальное хранилище с подготовкой к интеграции с S3-совместимым (OSS2)

### 3.2. Структура системы

Система состоит из трех основных контейнеризированных сервисов, управляемых через `docker-compose.yml`:

1.  **`backend`**: Flask-приложение, предоставляющее REST API.
2.  **`frontend`**: React SPA, взаимодействующее с API.
3.  **`db`**: PostgreSQL база данных.

#### Структура Backend-приложения
Проект имеет модульную структуру, где каждый файл отвечает за конкретную бизнес-логику или ресурс.

```
ShutDown-Team/
├── main.py                          # Точка входа, инициализация Flask
├── models.py                        # Модели данных SQLAlchemy (24 таблицы)
├── auth.py                          # Утилиты аутентификации и RBAC
├── qwen_api.py                      # Клиент для взаимодействия с Qwen AI
├── risk_calculator.py               # Сервис для динамического расчета рисков
├── notification_service.py          # Централизованный сервис создания уведомлений
├── project_access.py                # Декораторы для проверки прав доступа
├── *_routes.py                      # 20+ файлов с эндпоинтами для каждого ресурса
├── uploads/                         # Директория для загруженных файлов
└── templates/                       # Шаблоны документов (.docx)
```

#### Структура Frontend-приложения
Компоненты организованы по функциональному принципу (feature-based).

```
Front/src/
├── App.jsx                          # Корневой компонент с роутингом
├── apiService.js                    # Централизованный API-клиент с AbortController
├── authService.js                   # Управление токенами и сессией
├── Pages/                           # Компоненты-страницы (ProjectsPage, MapPage и т.д.)
├── Components/                      # Переиспользуемые UI-компоненты
│   ├── MainLayout.jsx               # Основной шаблон с навигацией и NotificationDropdown
│   ├── Dashboards/                  # Дашборды для каждой роли
│   ├── WorkPlan/                    # Компоненты для управления планом работ
│   ├── Tasks/                       # Компоненты задач (TaskCard, AllTasksModal)
│   ├── Issues/                      # Компоненты замечаний
│   ├── Notification/                # Компоненты системы уведомлений
│   ├── Risk/                        # Компоненты визуализации рисков
│   └── Map/                         # Компоненты интерактивной карты
└── utils/                           # Вспомогательные утилиты (геолокация, переводы)
```

### 3.3. Модель данных (Ключевые сущности)

База данных включает 24 таблицы, описывающие все аспекты строительного контроля.

-   **User**: Пользователи с ролями (`client`, `foreman`, `inspector`).
-   **Project**: Проекты с адресом, полигоном и динамическим `risk_score`.
-   **WorkPlan & WorkPlanItem**: Детализированный план работ, к которому привязываются задачи.
-   **Task**: Задачи с обязательной привязкой к `WorkPlanItem`, статусами и зависимостями.
-   **Issue**: Замечания и нарушения с привязкой к классификатору, фото и сроком устранения.
-   **Material**: Справочник строительных материалов.
-   **TaskMaterialUsage**: Таблица для учета фактического расхода материалов по задачам.
-   **Document**: Загруженные файлы (ТТН, паспорта) с результатами AI-распознавания.
-   **DailyReport**: Ежедневные отчеты прорабов.
-   **Notification**: Таблица для хранения персональных уведомлений пользователей.
-   **Checklist & ChecklistCompletion**: Шаблоны чек-листов и их заполненные экземпляры со статусами согласования.

---

## 4. Функциональные возможности по ролям

Система предоставляет уникальный набор инструментов для каждой роли, создавая единый и эффективный рабочий процесс.

### 4.1. Служба строительного контроля (Заказчик)
- **Полный контроль:** Просмотр всех проектов на карте и в списке с актуальными статусами и уровнями риска.
- **Планирование:** Создание и управление детализированными планами работ.
- **Верификация:** Подтверждение выполненных прорабом задач с фиксацией геолокации.
- **Надзор:** Создание замечаний по классификатору, назначение сроков и контроль устранения.
- **Аналитика:** Доступ к дашбордам с ключевыми метриками и аналитическим отчетам.

### 4.2. Прораб (Исполнитель)
- **Управление задачами:** Просмотр назначенных работ, отчет о выполнении с указанием расхода материалов.
- **Входной контроль:** Загрузка ТТН и паспортов качества с автоматическим AI-распознаванием.
- **Устранение замечаний:** Получение уведомлений о нарушениях и отчет об их исправлении с фотофиксацией.
- **Ежедневная отчетность:** Быстрое создание ежедневных отчетов о погоде, количестве рабочих и техники на объекте.

### 4.3. Инспектор (Контрольный орган)
- **Независимый аудит:** Полный read-only доступ ко всем данным системы по всем проектам.
- **Активация объектов:** Согласование актов открытия объектов, поданных службой контроля.
- **Фиксация нарушений:** Создание нарушений по собственному классификатору с назначением сроков.
- **Контроль устранения:** Проверка и подтверждение исправления нарушений прорабом.

---

## 5. Ключевые технические инновации

### 5.1. Система уведомлений в реальном времени
Полностью автоматизированная система информирования, построенная на polling-механизме.
- **Backend**: Централизованный `notification_service` генерирует уведомления по триггерам (создание замечания, завершение задачи и т.д.).
- **Frontend**: `MainLayout` каждые 30 секунд запрашивает количество непрочитанных уведомлений. `NotificationDropdown` отображает историю, автоматически помечает их прочитанными при просмотре и использует relative timestamps ("2 минуты назад") для удобства.
- **Эффективность**: Обеспечивает мгновенную реакцию участников на события, устраняя задержки в коммуникации.

### 5.2. AI-распознавание документов (Qwen API)
Интеграция с Vision-моделью Qwen для автоматизации входного контроля, работающая через отказоустойчивую очередь задач Celery.
- **Процесс**:
    1. **Загрузка**: Прораб загружает фото ТТН.
    2. **Задача**: Backend создает асинхронную задачу в Celery и немедленно возвращает ответ, не блокируя интерфейс.
    3. **Распознавание**: Celery worker в фоновом режиме отправляет файл в Qwen API, получает структурированный JSON с данными.
    4. **Верификация**: Прораб на специальном экране видит распознанные данные, может их скорректировать и подтвердить.
    5. **Оприходование**: После подтверждения прорабом система автоматически создает запись о поставке материалов (`MaterialDelivery`).
- **Интеллект**: Используется `Chain-of-Thought` промпт для высокой точности. Система не только извлекает данные, но и помогает прорабу в их валидации, а также может предложить наиболее вероятный проект для привязки поставки на основе геолокации адреса.
- **Аудит**: Все ответы от AI и действия пользователя сохраняются для последующего анализа.

### 5.3. Проактивная система оценки рисков
Динамический скоринг проектов, позволяющий предвидеть проблемы.
- **Механизм**: Каждому проекту присваивается балл от 0 до 1000. Оценка автоматически пересчитывается после каждого значимого события (пропуск отчета, новое нарушение, отклонение от графика).
- **Факторы риска (8)**: Включают дисциплину отчетности, количество просроченных задач, количество открытых нарушений, отклонение от графика, погодные условия и другие.
- **Визуализация**: Уровень риска (LOW, MEDIUM, HIGH, CRITICAL) отображается цветом на карточках проектов и на интерактивной карте, немедленно привлекая внимание к проблемным объектам.

### 5.4. Строгая привязка к плану работ
Ключевая функция, обеспечивающая порядок и учет.
- **Реализация**: В базе данных на поле `task.work_plan_item_id` установлено ограничение `NOT NULL`.
- **Workflow**: Пользователь не может создать задачу, не выбрав соответствующий пункт из ранее созданного плана работ. При завершении задачи прораб видит плановые объемы, что исключает ошибки и приписки.
- **Ценность**: Гарантирует, что 100% работ на объекте задокументированы, привязаны к бюджету и графику.

---

## 6. Развертывание и запуск

Система полностью контейнеризирована и запускается одной командой.

**Требования:**
- Docker
- Docker Compose

**Запуск:**
```bash
# 1. Убедитесь, что у вас есть файл .env с необходимыми переменными
# 2. Запустите все сервисы в фоновом режиме
docker-compose up -d --build
```

**Инициализация БД (при первом запуске):**
Выполните скрипт для создания таблиц и тестовых данных.
```bash
docker-compose exec backend python init_db.py
```
Скрипт создаст 24 таблицы, 3 тестовых пользователей, 6 проектов, классификаторы и справочник материалов.

**Доступ к сервисам:**
- **Frontend**: `http://localhost:3501`
- **Backend API**: `http://localhost:8501`

**Тестовые пользователи (пароль: `Password123`):**
- `client@example.com` (Служба контроля)
- `foreman@example.com` (Прораб)
- `inspector@example.com` (Инспектор)

---

## 7. Статус проекта и дальнейшее развитие

На данный момент проект находится на стадии **полнофункционального MVP (Minimum Viable Product)**. Реализованы все ключевые бизнес-процессы и инновационные функции.

**Готовность к Production:**
- ✅ Полная контейнеризация и оркестрация через Docker Compose.
- ✅ Реализованы все заявленные workflows.
- ✅ Применены базовые практики безопасности (хэширование, RBAC).
- ❌ **Требуется улучшение:** Вынос секретов из репозитория, внедрение полноценного CI/CD, покрытие кода тестами, настройка HTTPS и rate limiting.

**Возможные направления развития:**
- **Интеграция с BIM-моделями:** Связывание задач и замечаний с элементами информационных моделей зданий.
- **Расширенная аналитика:** Построение предиктивных моделей для прогнозирования сроков и бюджета.
- **Мобильное приложение:** Разработка нативных мобильных клиентов для iOS и Android для улучшения UX "в полях".
- **Финансовый модуль:** Интеграция смет и актов выполненных работ (КС-2, КС-3) для полного финансового контроля.

---

## 8. Справочник API Endpoints

### Аутентификация (`auth_routes.py`)
- `POST /api/login`: Вход в систему
- `POST /api/register`: Регистрация нового пользователя
- `GET /api/users/me`: Получение данных текущего пользователя

### Проекты (`project_routes.py`)
- `POST /api/projects`: Создание проекта (только client)
- `GET /api/projects`: Список проектов пользователя
- `GET /api/projects/:id`: Детали проекта

### План работ (`workplan_routes.py`)
- `POST /api/projects/:id/work-plan`: Создание плана работ (только client)
- `GET /api/projects/:id/work-plan`: Получение плана работ
- `PUT /api/projects/:id/work-plan`: Обновление плана работ (только client)
- `DELETE /api/projects/:id/work-plan`: Удаление плана работ (только client)

### Задачи (`task_routes.py`)
- `GET /api/tasks`: Список задач с фильтрацией
- `POST /api/tasks`: Создание задачи (требует `work_plan_item_id`)
- `PATCH /api/projects/:id/tasks/:id`: Отметка выполнения прорабом
- `POST /api/projects/:id/tasks/:id/verify`: Верификация службой контроля

### Замечания/Нарушения (`workflow_routes.py`, `issue_routes.py`)
- `POST /api/projects/:id/issues`: Создание замечания с геолокацией
- `GET /api/issues/:id`: Детали замечания
- `POST /api/issues/:id/resolve`: Устранение замечания прорабом
- `POST /api/issues/:id/verify`: Верификация устранения

### Уведомления (`notification_routes.py`)
- `GET /api/notifications`: Список уведомлений с пагинацией
- `GET /api/notifications/unread-count`: Счётчик непрочитанных
- `POST /api/notifications/mark-as-read`: Отметить как прочитанные

### Документы и Распознавание (`ttn_routes.py`)
- `POST /api/recognize/document`: Загрузка документа и запуск задачи распознавания в Celery
- `GET /api/recognize/status/<int:document_id>`: Проверка статуса задачи распознавания
- `POST /api/ttn/<int:document_id>/suggest-project`: Предложение проекта на основе адреса доставки из ТТН 🆕
- `POST /api/ttn/<int:document_id>/verify`: Верификация распознанных данных прорабом и создание поставки 🆕
- `GET /api/projects/:id/documents`: Список всех документов по проекту
- `GET /api/documents/:id/file`: Скачивание исходного файла документа

### Поставки и Материалы (`delivery_routes.py`, `material_routes.py`)
- `GET /api/projects/:id/deliveries`: Список поставок
- `GET /api/materials`: Список всех материалов из справочника

### Чек-листы (`checklist_routes.py`)
- `GET /api/checklists`: Список шаблонов
- `POST /api/checklists/:id/complete`: Заполнение чек-листа (только client)
- `GET /api/checklists/pending-approval`: Список на согласовании (только inspector)
- `POST /api/checklist-completions/:id/approve`: Одобрение инспектором
- `POST /api/checklist-completions/:id/reject`: Отклонение инспектором

### Прочее
- `GET /api/classifiers`: Список классификаторов
- `GET /api/dashboard/summary`: Сводная информация для дашборда
- `GET /api/map/projects_status`: GeoJSON с проектами для карты
- `POST /api/daily-reports`: Создание ежедневного отчета
- `GET /api/projects/:id/risk`: Текущий риск проекта