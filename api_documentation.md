
# Документация по API "СтройКонтроль"

**Версия:** 3.0 (Refactored)
**Базовый URL:** `/api`

## 1. Концепция

Это API построено по принципу "умного бэкенда". Вместо простых CRUD-операций, эндпоинты стараются моделировать бизнес-процессы и возвращать обогащенные, готовые к использованию данные. Фронтенд должен делать как можно меньше вычислений, агрегаций и дополнительных запросов.

### 1.1 Аутентификация

Все запросы к API требуют `Authorization: Bearer <jwt_token>` заголовка. Токен получается через `POST /api/auth/login`.

### 1.2 Роли

- `client`: Заказчик. Управляет проектами.
- `foreman`: Прораб. Выполняет задачи, фиксирует поставки.
- `inspector`: Инспектор. Контролирует, верифицирует, создает нарушения.

---

## 2. Аутентификация (`/api/auth`)

*Эндпоинты не изменились, но были вынесены в отдельный блюпринт.*

- `POST /auth/register`: Регистрация нового пользователя.
- `POST /auth/login`: Вход, получение JWT токена.
- `GET /auth/profile`: Получение данных о текущем пользователе.

---

## 3. Проекты (`/api/projects`)

*Основной эндпоинт для получения списка проектов. Переписан для эффективности.*

### `GET /projects`
- **Описание:** Возвращает список проектов, доступных пользователю, с агрегированными данными.
- **Доступ:** Любой аутентифицированный пользователь.
- **Логика:**
    - `inspector` видит все проекты.
    - `client` и `foreman` видят только те проекты, в которых они состоят.
- **Ответ (200):**
  ```json
  [
    {
      "id": 1,
      "name": "ЖК 'Солнечный город', Корпус 5",
      "address": "г. Москва, ул. Строителей, д. 12",
      "status": "active",
      "polygon": { "type": "Feature", ... },
      "created_at": "2025-09-28T10:00:00Z",
      "tasks_count": 25, // Общее количество задач
      "issues_count": 3    // Количество открытых нарушений
    }
  ]
  ```

### `POST /projects`
- **Описание:** Создает новый проект.
- **Доступ:** `client`
- **Тело запроса (JSON):**
  ```json
  {
    "name": "Новый ЖК",
    "address": "г. Москва, Новый проезд, 1",
    "polygon": { ... } // Опционально, может быть сгенерирован на бэкенде
  }
  ```
- **Ответ (201):** Возвращает созданный объект проекта с `tasks_count: 0` и `issues_count: 0`.

---

## 4. Задачи (`/api/tasks`)

*Новый набор эндпоинтов для гранулярного управления задачами.*

### `GET /tasks`
- **Описание:** Возвращает список задач с возможностью фильтрации.
- **Доступ:** Любой аутентифицированный пользователь.
- **Query параметры:**
    - `status=completed`: для получения задач на верификацию.
    - `assignee_id=1`: для получения задач конкретного исполнителя.
- **Ответ (200):** Массив объектов задач.

### `POST /projects/<int:project_id>/tasks`
- **Описание:** Создает новую задачу в проекте.
- **Доступ:** `client`

### `PUT /tasks/<int:task_id>`
- **Описание:** Обновляет задачу (название, даты).
- **Доступ:** `client`

---

## 5. Распознавание и Поставки

*Процесс разделен на два этапа: распознавание и регистрация поставки.*

### `POST /recognize/document`
- **Описание:** Запускает асинхронную задачу по распознаванию документа (ТТН).
- **Доступ:** `foreman`
- **Тело запроса:** `multipart/form-data` с полями `project_id` и `file`.
- **Ответ (202):**
  ```json
  {
    "message": "Распознавание запущено...",
    "document_id": 123
  }
  ```

### `GET /recognize/status/<int:document_id>`
- **Описание:** Проверяет статус распознавания. Возвращает `recognition_status` (`processing`, `completed`, `failed`) и `recognized_data` при успехе.

### `POST /projects/<int:project_id>/deliveries`
- **Описание:** Регистрирует факт поставки материалов в системе.
- **Доступ:** `foreman`
- **Тело запроса (JSON):** Принимает `document_id` (из эндпоинта распознавания) и массив `items` с проверенными пользователем данными.
  ```json
  {
    "document_id": 123,
    "items": [
      { "name": "Бетон М300", "quantity": 50, "unit": "м³" },
      { "name": "Арматура А500С", "quantity": 1500, "unit": "кг" }
    ]
  }
  ```
- **Ответ (201):** `{"message": "Поставка успешно зарегистрирована"}`

---

## 6. Нарушения (`/api/issues`)

*Новый набор эндпоинтов для управления нарушениями.*

### `GET /issues`
- **Описание:** Возвращает список нарушений с фильтрацией.
- **Доступ:** Любой аутентифицированный пользователь.
- **Query параметры:**
    - `status=open`: для получения только открытых нарушений.

### `POST /projects/<int:project_id>/issues`
- **Описание:** Создает новое нарушение.
- **Доступ:** `inspector`
- **Тело запроса (JSON):**
  ```json
  {
    "type": "violation",
    "classifier_id": 101,
    "description": "Отсутствуют ограждения...",
    "due_date": "2025-10-10"
  }
  ```

---

## 7. Отчёты (`/api/daily-reports`)

*Эндпоинт переписан для возврата обогащенных данных.*

### `GET /daily-reports`
- **Описание:** Возвращает список всех ежедневных отчетов.
- **Ответ (200):**
  ```json
  [
    {
        "id": 1,
        "report_date": "2025-09-28",
        "notes": "Работы по графику.",
        "project_name": "ЖК 'Солнечный город', Корпус 5",
        "author_name": "Иван Прорабов"
    }
  ]
  ```
